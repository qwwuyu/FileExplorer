<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>ctrl</title>
	<script src="js/jquery.min.js"></script>
	<script src="js/template.js"></script>
	<link href="css/1.css" type="text/css" rel="stylesheet"/>
</head>
<body>
	<form id="uploadForm">
		<input id="fileId1" type="file" accept="*" name="file" multiple="multiple"/>
	</form>
	<button id="uploadTarget">上传至当前文件夹</button>
	<ul id="list">
		
	</ul>
</body>
<script type="text/html" id="listTemp">
	<a href="javascript:void(0);" id="back">../</a>
	{{each list as value i}}
	<li>
		{{if value.isDirectory}}
		<a href="javascript:void(0);" class="openFolder" data-path={{value.path}}>{{value.name}}</a>
		{{else}}
		{{value.name}}
		<div>
			<a href="i/down{{value.path}}">下载</a>
			<a href="i/look{{value.path}}">打开</a>
			<a href="javascript:void(0)" data-url="i/del{{value.path}}" class="deleteFileA">删除</a>
		</div>
		{{/if}}
	</li>
	{{/each}}
</script>
<script type="text/javascript">
	var main = {
		init: function () {
			this.bindEvent();
			this.load();
		},
		bindEvent: function () {
			var self = this;
			$('body').on('click', '.openFolder', function (e) {
				var path = $(this).data('path');
				if((location.search != ('?path=' + path)) && (location.search == '')) {
					history.pushState({}, path, location.href + '?path=' + path);
				}else{
					var arg = location.href.substring(location.href.indexOf('?') + 6),
						url = location.href.replace(arg, path);
					history.pushState({}, path, url);
				}
				var promise = $.ajax({
					url: "i/root" + path,
					type: 'GET',
					dataType: 'JSONP'
				});
				promise.done(function (data) {
					var list = data,
						html = template('listTemp', {
							list: list
						});
					$('#list').html(html);
				}).fail(function (jqXHR, textStatus, ex) {
					
				});
			}).on('click', '#back', function (e) {
				history.go(-1);
			}).on('click', '#uploadTarget', function (e) {
				var paramObj = self.getUrlParam();
				self.show(paramObj.path);
			}).on('click', '.deleteFileA', function (e) {
				self.deleteFile($(this).data('url'));
			});
			window.onpopstate = function(event) {
				var promise = $.ajax({
					url: "i/root" + (location.pathname == '/upload' ? '' : location.pathname),
					type: 'GET',
					dataType: 'JSONP'
				});
				promise.done(function (data) {
					var list = data,
						html = template('listTemp', {
							list: list
						});
					$('#list').html(html);
				}).fail(function (jqXHR, textStatus, ex) {
					
				});
			};
		},
		show: function (path) {
			var self = this;
			var url = "i/upload";
			var oFiles = document.querySelector("#uploadForm");
			var formData = new FormData(oFiles);
			var promise = $.ajax({  
				url:  url + (path || ''),  
				type: 'POST',  
				data: formData, 
				async: false,  
				cache: false,  
				contentType: false,  
				processData: false 
			}); 
			promise.then(function (res) { 
				self.load();
				alert(JSON.stringify(res));
			});
		},
		load: function () {
			var paramObj = this.getUrlParam();
			var promise = $.ajax({
				url: "i/root" + (paramObj.path || ''),
				type: 'GET',
				dataType: 'JSONP'
			});
			promise.done(function (data) {
				var list = data,
					html = template('listTemp', {
						list: list
					});
				$('#list').html(html);
			}).fail(function (jqXHR, textStatus, ex) {
				
			});
		},
		getUrlParam: function () {
			var url = location.href;
			var obj={};
			var keyvalue=[];
			var key="",value="";       
			var paraString=url.substring(url.indexOf("?")+1,url.length).split("&");
			for(var i in paraString)
			{
				keyvalue=paraString[i].split("=");
				key=keyvalue[0];
				value=keyvalue[1];
				obj[key]=value;            
			}        
			return obj;
		},
		deleteFile: function (url) {
			var self = this;
			var promise = $.ajax({  
				url: url,  
				type: 'POST',  
				data: {}, 
				async: false,  
				cache: false,  
				contentType: false,  
				processData: false 
			}); 
			promise.then(function (res) { 
				alert(JSON.stringify(res));
				self.load();
			});
		}
	};
	main.init();
</script>
</html>